version: 0.2.{build}

# branches / commits to build
skip_commits:
  message: /WIP/

skip_branch_with_pr: true
skip_tags: true

# environment
image: Visual Studio 2017
cache:
  - packages
configuration: Release

hosts:
  localhost: 127.0.0.1
  kafkalocal: 127.0.0.1  

os: Visual Studio 2017
install:
  - docker version

build_script:
  - appveyor-retry dotnet restore --packages packages
  - dotnet build -c %CONFIGURATION% src\KafkaClient\KafkaClient.csproj --no-dependencies --no-incremental --version-suffix %APPVEYOR_BUILD_NUMBER%
  - dotnet pack -c %CONFIGURATION% src\KafkaClient\KafkaClient.csproj --version-suffix beta -o artifacts 

test_script:
  - dotnet test -c %CONFIGURATION% -f netcoreapp1.1 src\KafkaClient.Tests\KafkaClient.Tests.csproj --filter "(TestCategory=CI) & (TestCategory!=Flaky)" --logger:trx;LogFileName=test-results.xml;format=AppVeyor
  - ps: $wc = New-Object 'System.Net.WebClient'; $wc.UploadFile("https://ci.appveyor.com/api/testresults/nunit3/$($env:APPVEYOR_JOB_ID)", (Resolve-Path src\KafkaClient.Tests\TestResults\test-results.xml))
  # - docker run -d --name zookeeper --publish 2181:2181 zookeeper:3.4
  # - docker run -d --name kafka10_1 --publish 9092:9092 --env ZOOKEEPER_IP=zookeeper --env  KAFKA_BROKER_ID=0 --env KAFKA_DELETE_TOPIC_ENABLE=true --env KAFKA_ADVERTISED_HOST_NAME=kafkalocal ches/kafka:0.10.1.1
  # - docker ps
  # - dotnet test -c %CONFIGURATION% -f netcoreapp1.1 src\KafkaClient.Tests\KafkaClient.Tests.csproj --filter "(TestCategory=Integration) & (TestCategory!=Flaky)" --logger:trx;LogFileName=test-results.xml;format=AppVeyor

artifacts:
  - path: artifacts\**\*.*
